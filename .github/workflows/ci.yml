name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  # VCV Rack SDK configuration
  # To update: download new SDK from https://vcvrack.com/downloads/
  # Then run: sha256sum Rack-SDK-<version>-lin-x64.zip
  VCV_SDK_VERSION: "2.5.2"
  VCV_SDK_SHA256: "228e6a415b09fbd5536cdd588a01472d81d470ea2fc747cf05e5e56ef25d5c09"

jobs:
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install all build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang-format \
          clang-tidy \
          build-essential \
          cmake \
          ninja-build \
          libglu1-mesa-dev \
          libx11-dev \
          libxext-dev \
          libxcursor-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxi-dev \
          libxcomposite-dev \
          libxrender-dev \
          libasound2-dev \
          libjack-jackd2-dev \
          libcurl4-openssl-dev \
          libfreetype6-dev \
          libwebkit2gtk-4.1-dev \
          mesa-common-dev \
          zlib1g-dev \
          wget \
          unzip

    - name: Download and verify Rack SDK
      run: |
        cd ..
        wget -q https://vcvrack.com/downloads/Rack-SDK-${VCV_SDK_VERSION}-lin-x64.zip
        echo "${VCV_SDK_SHA256}  Rack-SDK-${VCV_SDK_VERSION}-lin-x64.zip" | sha256sum -c -
        unzip -q Rack-SDK-*.zip
        mv Rack-SDK Rack

    - name: Check formatting
      run: |
        echo "Checking code formatting..."
        find libs plugins -name "*.cpp" -o -name "*.hpp" -o -name "*.h" | \
          xargs clang-format --dry-run --Werror --style=file

    - name: Run clang-tidy
      run: |
        echo "Running static analysis..."
        find libs/octobir-core/src plugins/vcv-rack/src -name "*.cpp" | \
          xargs -I {} clang-tidy {} \
            -- \
            -I./libs/octobir-core/include \
            -I./third_party/WDL/WDL \
            -I./third_party \
            -I../Rack/include \
            -I../Rack/dep/include \
            -std=c++11

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build

    - name: Configure CMake
      run: |
        cmake -B build/test \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_JUCE_PLUGIN=OFF \
          -DBUILD_VCV_PLUGIN=OFF \
          -DBUILD_TESTS=ON \
          -G Ninja

    - name: Build tests
      run: cmake --build build/test --target octobir-core-tests -j

    - name: Run tests
      run: ./build/test/libs/octobir-core/tests/octobir-core-tests

  build-vcv:
    name: Build VCV Plugin
    runs-on: ubuntu-latest
    needs: lint

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libglu1-mesa-dev libx11-dev libxext-dev libxcursor-dev libxrandr-dev libxinerama-dev libxi-dev zlib1g-dev wget unzip

    - name: Download and verify Rack SDK
      run: |
        cd ..
        wget -q https://vcvrack.com/downloads/Rack-SDK-${VCV_SDK_VERSION}-lin-x64.zip
        echo "${VCV_SDK_SHA256}  Rack-SDK-${VCV_SDK_VERSION}-lin-x64.zip" | sha256sum -c -
        unzip -q Rack-SDK-*.zip
        mv Rack-SDK Rack

    - name: Build plugin
      run: |
        cd plugins/vcv-rack
        export RACK_DIR=../../../Rack
        make dep
        make

  build-juce:
    name: Build JUCE Plugin
    runs-on: ubuntu-latest
    needs: lint

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libasound2-dev \
          libjack-jackd2-dev \
          libcurl4-openssl-dev \
          libfreetype6-dev \
          libx11-dev \
          libxcomposite-dev \
          libxcursor-dev \
          libxext-dev \
          libxinerama-dev \
          libxrandr-dev \
          libxrender-dev \
          libwebkit2gtk-4.1-dev \
          libglu1-mesa-dev \
          mesa-common-dev

    - name: Build JUCE Plugin
      run: |
        cmake -B build/juce-ci \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_JUCE_PLUGIN=ON \
          -DBUILD_VCV_PLUGIN=OFF \
          -G Ninja
        cmake --build build/juce-ci --target OctobIR -j