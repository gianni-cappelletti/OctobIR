name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  # VCV Rack SDK configuration
  # To update SDK version, modify scripts/vcv-sdk-config.sh
  # This file is sourced to ensure version consistency across CI and local builds
  VCV_SDK_VERSION: "2.5.2"
  VCV_SDK_SHA256: "228e6a415b09fbd5536cdd588a01472d81d470ea2fc747cf05e5e56ef25d5c09"

jobs:
  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Verify license files exist
      run: |
        echo "Checking for required license documentation..."

        if [ ! -f "LICENSE" ]; then
          echo "Error: LICENSE file not found"
          exit 1
        fi
        echo "✓ LICENSE found"

        if [ ! -f "LICENSING.md" ]; then
          echo "Error: LICENSING.md file not found"
          exit 1
        fi
        echo "✓ LICENSING.md found"

        if [ ! -f "THIRD_PARTY_NOTICES.txt" ]; then
          echo "Error: THIRD_PARTY_NOTICES.txt file not found"
          exit 1
        fi
        echo "✓ THIRD_PARTY_NOTICES.txt found"

        echo ""
        echo "All required license files present"

  setup-vcv-sdk:
    name: Setup VCV Rack SDK
    runs-on: ubuntu-latest

    steps:
    - name: Download and verify VCV Rack SDK
      run: |
        wget -q https://vcvrack.com/downloads/Rack-SDK-${VCV_SDK_VERSION}-lin-x64.zip
        echo "${VCV_SDK_SHA256}  Rack-SDK-${VCV_SDK_VERSION}-lin-x64.zip" | sha256sum -c -
        unzip -q Rack-SDK-*.zip
        mv Rack-SDK Rack

    - name: Upload SDK artifact
      uses: actions/upload-artifact@v4
      with:
        name: vcv-rack-sdk
        path: Rack/
        retention-days: 1

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    needs: [setup-vcv-sdk, license-compliance]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Download VCV Rack SDK
      uses: actions/download-artifact@v4
      with:
        name: vcv-rack-sdk
        path: ../Rack

    - name: Install code quality tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format clang-tidy

    - name: Check formatting
      run: |
        echo "Checking code formatting..."
        find libs plugins -name "*.cpp" -o -name "*.hpp" -o -name "*.h" | \
          xargs clang-format --dry-run --Werror --style=file

    - name: Run clang-tidy
      run: |
        echo "Running static analysis..."
        find libs/octobir-core/src plugins/vcv-rack/src -name "*.cpp" | \
          xargs -I {} clang-tidy {} \
            -- \
            -I./libs/octobir-core/include \
            -I./third_party/WDL/WDL \
            -I./third_party \
            -I../Rack/include \
            -I../Rack/dep/include \
            -std=c++11

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [static-analysis]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake ninja-build

    - name: Configure CMake
      run: |
        cmake -B build/test \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_JUCE_PLUGIN=OFF \
          -DBUILD_VCV_PLUGIN=OFF \
          -DBUILD_TESTS=ON \
          -G Ninja

    - name: Build tests
      run: cmake --build build/test --target octobir-core-tests -j

    - name: Run tests
      run: ./build/test/libs/octobir-core/tests/octobir-core-tests

  build-vcv:
    name: Build VCV Plugin
    runs-on: ubuntu-latest
    needs: [setup-vcv-sdk, static-analysis]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Download VCV Rack SDK
      uses: actions/download-artifact@v4
      with:
        name: vcv-rack-sdk
        path: ../Rack

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libglu1-mesa-dev libx11-dev libxext-dev libxcursor-dev libxrandr-dev libxinerama-dev libxi-dev zlib1g-dev

    - name: Build plugin
      run: |
        cd plugins/vcv-rack
        export RACK_DIR=../../../Rack
        make dep
        make

  build-juce:
    name: Build JUCE Plugin
    runs-on: ubuntu-latest
    needs: [static-analysis]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libasound2-dev \
          libjack-jackd2-dev \
          libcurl4-openssl-dev \
          libfreetype6-dev \
          libx11-dev \
          libxcomposite-dev \
          libxcursor-dev \
          libxext-dev \
          libxinerama-dev \
          libxrandr-dev \
          libxrender-dev \
          libwebkit2gtk-4.1-dev \
          libglu1-mesa-dev \
          mesa-common-dev

    - name: Build JUCE Plugin
      run: |
        cmake -B build/juce-ci \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_JUCE_PLUGIN=ON \
          -DBUILD_VCV_PLUGIN=OFF \
          -G Ninja
        cmake --build build/juce-ci --target OctobIR_All -j