#!/bin/bash

# Pre-commit hook to auto-format C++ code with clang-format

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Check if clang-format is installed
if ! command -v clang-format &> /dev/null; then
    echo -e "${RED}Error: clang-format is not installed${NC}"
    echo "Please install clang-format to use this pre-commit hook"
    exit 1
fi

# Get the list of staged C++ files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | \
    grep -E '\.(cpp|hpp|c|h)$' | \
    grep -v '^third_party/' || true)

if [ -z "$STAGED_FILES" ]; then
    # No C++ files staged, allow commit
    exit 0
fi

echo "Checking code formatting..."

# Track if any files have formatting issues
FORMAT_ISSUES=0
FORMATTED_FILES=()

# Check each staged file
for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
        # Run clang-format in dry-run mode to check if formatting is needed
        if ! clang-format --dry-run --Werror "$FILE" &>/dev/null; then
            FORMAT_ISSUES=1
            FORMATTED_FILES+=("$FILE")
        fi
    fi
done

# If formatting issues found, auto-format and re-stage
if [ $FORMAT_ISSUES -eq 1 ]; then
    echo -e "${YELLOW}Auto-formatting the following files:${NC}"
    for FILE in "${FORMATTED_FILES[@]}"; do
        echo -e "  ${CYAN}$FILE${NC}"
        clang-format -i "$FILE"
        git add "$FILE"
    done
    echo ""
    echo -e "${YELLOW}Files have been auto-formatted and re-staged.${NC}"
    echo -e "${YELLOW}Please review the changes and commit again.${NC}"
    echo ""
    echo -e "Run ${CYAN}git diff --cached${NC} to see the formatting changes."
    exit 1
fi

echo -e "${GREEN}All staged files are properly formatted${NC}"
exit 0